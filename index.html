<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥ ì¹´ë“œ</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --shadow: 0 12px 32px rgba(0,0,0,.12);
      --radius: 26px;

      --accent:#ef4444;

      --btn:#111827;
      --btnText:#ffffff;
      --btn2:#e5e7eb;
      --btn2Text:#111827;
      --danger:#ef4444;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .app{ width:min(1040px, 100%); display:grid; gap:16px; }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .title{ font-size:18px; font-weight:900; }
    .meta{ color:var(--muted); font-size:13px; }

    .rightBox{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      min-width: 260px;
    }

    .controls{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    button{
      border:0; border-radius:14px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .primary{ background:var(--btn); color:var(--btnText); }
    .secondary{ background:var(--btn2); color:var(--btn2Text); }
    .danger{ background:var(--danger); color:white; }
    .small{ padding:9px 12px; border-radius:12px; font-weight:900; }

    .ttsBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .ttsBar input[type="range"]{
      width:140px;
      accent-color: var(--accent);
    }
    .pillMini{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:6px 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:34px;
      display:grid;
      gap:18px;
      position:relative;
      overflow:hidden;
    }
    .posLine{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      font-weight:800;
      margin-top:-6px;
    }
    .hanzi{
      font-size:92px;
      line-height:1;
      text-align:center;
      font-weight:900;
      letter-spacing:1px;
      padding:6px 10px;
    }

    .row{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:stretch;
      flex-wrap:wrap;
      padding-top:4px;
    }

    .pill{
      border-radius:16px;
      padding:12px 16px;
      background:#fff;
      border:2px solid var(--accent);
      min-width: 240px;
      max-width: 100%;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .pinyin{
      font-style: normal;
      color: var(--muted);
      font-size: 18px;
      font-weight: 800;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      letter-spacing: .2px;
    }
    .korean{ font-size:18px; font-weight:900; }

    .hiddenText{
      filter: blur(9px);
      user-select:none;
    }

    .panel{
      background:rgba(255,255,255,.70);
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    textarea{
      width:100%;
      min-height:170px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
      resize:vertical;
      outline:none;
      background:white;
    }
    .panelRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .hint{
      color:var(--muted);
      font-size:13px;
      margin-top:8px;
      line-height:1.5;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      background:#111827;
      color:white;
      border-radius:8px;
      padding:2px 7px;
      font-size:12px;
    }
    .footerHint{ text-align:center; color:var(--muted); font-size:12px; }

    @media (max-width:720px){
      .rightBox{ align-items:flex-start; min-width:unset; width:100%; }
      .ttsBar{ justify-content:flex-start; }
    }
    @media (max-width:560px){
      .hanzi{ font-size:76px; }
      .pill{ min-width: 100%; }
      .ttsBar input[type="range"]{ width: 180px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div>
        <div class="title">ì¤‘êµ­ì–´ ë‹¨ì–´ì¥ ì¹´ë“œ</div>
        <div class="meta" id="meta"></div>
      </div>

      <div class="rightBox">
        <div class="controls">
          <button class="secondary small" id="toggleHide">ëœ» ê°€ë¦¬ê¸°</button>
          <button class="secondary small" id="speak">ğŸ”Š ë“£ê¸°</button>
          <button class="secondary small" id="random">ëœë¤</button>
          <button class="secondary small" id="prev">ì´ì „</button>
          <button class="primary small" id="next">ë‹¤ìŒ</button>
        </div>

        <div class="ttsBar">
          <span class="pillMini">ì†ë„</span>
          <input type="range" id="rate" min="0.6" max="1.2" step="0.05" value="0.9" />
          <span class="pillMini" id="rateLabel">0.90Ã—</span>
          <span class="pillMini" id="voiceLabel">voice: auto</span>
        </div>
      </div>
    </div>

    <div class="card" aria-live="polite" id="card">
      <div class="posLine" id="pos"> </div>
      <div class="hanzi" id="hanzi">â€”</div>
      <div class="row">
        <div class="pill">
          <div class="label">ë³‘ìŒ</div>
          <div class="pinyin" id="pinyin">â€”</div>
        </div>
        <div class="pill">
          <div class="label">í•œêµ­ì–´</div>
          <div class="korean" id="korean">â€”</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panelRow">
        <div style="font-weight:900;">ë°ì´í„° ë¶™ì—¬ë„£ê¸°</div>
        <div class="controls">
          <button class="primary small" id="load">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="secondary small" id="sample">ìƒ˜í”Œ</button>
          <button class="danger small" id="clear">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <textarea id="input" placeholder="ì‰¼í‘œ(CSV) ë˜ëŠ” ì›ë˜ ê³µë°± í˜•ì‹ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ë„ ë¼!
ì˜ˆ)
åœ°é“,dÃ¬tiÄ›,ì§€í•˜ì² /ì „ì² ,ëª…ì‚¬
æŒ¤,jÇ,ë¶ë¹„ë‹¤,í˜•ìš©ì‚¬/ë™ì‚¬"></textarea>

      <div class="hint">
        ì§€ì› í˜•ì‹<br/>
        1) <b>í•œì,ë³‘ìŒ,í•œêµ­ì–´,í’ˆì‚¬(ì„ íƒ)</b> (ì‰¼í‘œ êµ¬ë¶„)<br/>
        2) <b>í•œì ë³‘ìŒ í•œêµ­ì–´ í’ˆì‚¬</b> (ê³µë°± êµ¬ë¶„)<br/>
        ë‹¨ì¶•í‚¤:
        <span class="kbd">â†</span> ì´ì „ /
        <span class="kbd">â†’</span> ë‹¤ìŒ /
        <span class="kbd">R</span> ëœë¤ /
        <span class="kbd">H</span> ëœ» ê°€ë¦¬ê¸° /
        <span class="kbd">S</span> ë“£ê¸°
      </div>
    </div>

    <div class="footerHint">â€» ë°ì´í„°/ì…ë ¥ì¹¸/ì„¤ì •ì€ ì´ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë¼. (localStorage)</div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "vocab_cards_v1";
  const INPUT_KEY   = "vocab_cards_input_v1";
  const TTS_KEY     = "vocab_cards_tts_v1";

  // âœ… ì—¬ê¸° íŒŒì¼ ì´ë¦„ë§Œ ë§ìœ¼ë©´ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§
  const DEFAULT_CSV_FILE = "vocab.csv";

  let cards = [];
  let idx = 0;
  let hideMeaning = false;

  let ttsRate = 0.9;
  let chosenVoiceName = "auto";

  function parseLines(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const parsed = [];

    for (const line of lines) {
      if (line.includes(",")) {
        const parts = line.split(",").map(s => s.trim());
        if (parts.length < 3) continue;
        const [hanzi, pinyin, korean, pos] = parts;
        parsed.push({ hanzi, pinyin, korean, pos: pos || "" });
        continue;
      }

      const tokens = line.split(/\s+/);
      if (tokens.length < 4) continue;

      const hanzi = tokens[0];
      const pos = tokens[tokens.length - 1];

      let firstKoIdx = -1;
      for (let i = 1; i < tokens.length - 1; i++) {
        if (/[ê°€-í£]/.test(tokens[i])) { firstKoIdx = i; break; }
      }
      if (firstKoIdx === -1) continue;

      const pinyin = tokens.slice(1, firstKoIdx).join(" ");
      const korean = tokens.slice(firstKoIdx, tokens.length - 1).join(" ");

      parsed.push({ hanzi, pinyin, korean, pos });
    }

    return parsed;
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ cards, idx, hideMeaning }));
    localStorage.setItem(INPUT_KEY, $("input").value);
    localStorage.setItem(TTS_KEY, JSON.stringify({ ttsRate, chosenVoiceName }));
  }

  function loadSaved() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try{
        const obj = JSON.parse(raw);
        if (Array.isArray(obj.cards)) cards = obj.cards;
        if (Number.isFinite(obj.idx)) idx = obj.idx;
        if (typeof obj.hideMeaning === "boolean") hideMeaning = obj.hideMeaning;
      }catch(e){}
    }

    const savedText = localStorage.getItem(INPUT_KEY);
    if (savedText !== null) $("input").value = savedText;

    const savedTTS = localStorage.getItem(TTS_KEY);
    if (savedTTS) {
      try{
        const t = JSON.parse(savedTTS);
        if (typeof t.ttsRate === "number") ttsRate = t.ttsRate;
        if (typeof t.chosenVoiceName === "string") chosenVoiceName = t.chosenVoiceName;
      }catch(e){}
    }
  }

  function clampIndex() {
    if (cards.length === 0) { idx = 0; return; }
    if (idx < 0) idx = 0;
    if (idx >= cards.length) idx = cards.length - 1;
  }

  function render() {
    clampIndex();

    if (cards.length === 0) {
      $("hanzi").textContent = "ë°ì´í„° ì—†ìŒ";
      $("pinyin").textContent = "â€”";
      $("korean").textContent = "â€”";
      $("pos").textContent = "";
      $("meta").textContent = "ìë™ ë¡œë“œ ì¤‘ì´ê±°ë‚˜, ì•„ë˜ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  â€˜ë¶ˆëŸ¬ì˜¤ê¸°â€™ ëˆŒëŸ¬ì¤˜!";
      return;
    }

    const c = cards[idx];
    $("hanzi").textContent = c.hanzi || "â€”";
    $("pinyin").textContent = c.pinyin || "â€”";
    $("pos").textContent = c.pos ? c.pos : "";

    const ko = $("korean");
    ko.textContent = c.korean || "â€”";
    ko.classList.toggle("hiddenText", hideMeaning);

    $("meta").textContent = `${idx + 1} / ${cards.length}` + (c.pos ? ` Â· ${c.pos}` : "");
  }

  function next() {
    if (cards.length === 0) return;
    idx = (idx + 1) % cards.length;
    render(); save();
  }
  function prev() {
    if (cards.length === 0) return;
    idx = (idx - 1 + cards.length) % cards.length;
    render(); save();
  }
  function randomPick() {
    if (cards.length === 0) return;
    if (cards.length === 1) { idx = 0; render(); save(); return; }
    let r;
    do { r = Math.floor(Math.random() * cards.length); } while (r === idx);
    idx = r;
    render(); save();
  }

  function getPreferredVoice() {
    if (!("speechSynthesis" in window)) return null;

    const voices = window.speechSynthesis.getVoices() || [];
    if (voices.length === 0) return null;

    if (chosenVoiceName && chosenVoiceName !== "auto") {
      const exact = voices.find(v => v.name === chosenVoiceName);
      if (exact) return exact;
    }

    const zh = voices.find(v =>
      (v.lang && v.lang.toLowerCase().startsWith("zh")) ||
      (v.name && /chinese|mandarin|zh/i.test(v.name))
    );
    return zh || voices[0];
  }

  function refreshVoiceLabel() {
    const v = getPreferredVoice();
    $("voiceLabel").textContent = v ? `voice: ${v.lang || "?"}` : "voice: loading...";
  }

  function speakChinese(text) {
    if (!("speechSynthesis" in window)) {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„ ã… ã… ");
      return;
    }
    if (!text || text === "â€”" || text === "ë°ì´í„° ì—†ìŒ") return;

    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-CN";
    u.rate = ttsRate;
    u.pitch = 1.0;

    const v = getPreferredVoice();
    if (v) u.voice = v;

    window.speechSynthesis.speak(u);
  }

  function speakCurrent() {
    if (cards.length === 0) return;
    speakChinese(cards[idx].hanzi);
  }

  // âœ… ìë™ ë¡œë“œ: ì €ì¥ëœ ì¹´ë“œê°€ ì—†ìœ¼ë©´ vocab.csvë¥¼ ì½ì–´ì™€ì„œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
  async function autoLoadDefaultIfNeeded() {
    const hasSavedCards = Array.isArray(cards) && cards.length > 0;
    const hasInputText = ($("input").value || "").trim().length > 0;

    if (hasSavedCards) return; // ì´ë¯¸ ì €ì¥ëœ ì¹´ë“œê°€ ìˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ

    // ì…ë ¥ì¹¸ì´ ë¹„ì–´ìˆê±°ë‚˜(ì²˜ìŒ) + ì €ì¥ëœ ì¹´ë“œê°€ ì—†ìœ¼ë©´ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
    if (!hasInputText) {
      try{
        const res = await fetch(`${DEFAULT_CSV_FILE}?v=${Date.now()}`);
        if (!res.ok) throw new Error("fetch failed");
        const text = await res.text();

        $("input").value = text;
        localStorage.setItem(INPUT_KEY, text);

        const parsed = parseLines(text);
        if (parsed.length > 0) {
          cards = parsed;
          idx = 0;
          render();
          save();
        } else {
          render();
          console.warn("vocab.csv íŒŒì‹± ê²°ê³¼ê°€ 0ê°œì•¼. í˜•ì‹ í™•ì¸ í•„ìš”.");
        }
      }catch(e){
        // íŒŒì¼ì´ ì—†ê±°ë‚˜ ê²½ë¡œê°€ ë‹¤ë¥´ë©´ ì—¬ê¸°ë¡œ ì˜´
        render();
        console.warn("ê¸°ë³¸ ë°ì´í„° ìë™ ë¡œë“œ ì‹¤íŒ¨:", e);
      }
    } else {
      // ì…ë ¥ì¹¸ì€ ìˆëŠ”ë°(ì‚¬ìš©ìê°€ ë„£ì–´ë‘ ) ì¹´ë“œ ì €ì¥ì´ ì—†ëŠ” ê²½ìš°: ì…ë ¥ì¹¸ ê¸°ë°˜ ìë™ ë¡œë“œ
      const parsed = parseLines($("input").value.trim());
      if (parsed.length > 0) {
        cards = parsed;
        idx = 0;
        render();
        save();
      } else {
        render();
      }
    }
  }

  // UI events
  $("next").addEventListener("click", next);
  $("prev").addEventListener("click", prev);
  $("random").addEventListener("click", randomPick);

  $("toggleHide").addEventListener("click", () => {
    hideMeaning = !hideMeaning;
    $("toggleHide").textContent = hideMeaning ? "ëœ» ë³´ì´ê¸°" : "ëœ» ê°€ë¦¬ê¸°";
    render(); save();
  });

  $("speak").addEventListener("click", () => {
    speakCurrent();
  });

  const rateEl = $("rate");
  const rateLabel = $("rateLabel");
  function setRate(val) {
    ttsRate = Number(val);
    rateEl.value = String(ttsRate);
    rateLabel.textContent = `${ttsRate.toFixed(2)}Ã—`;
    save();
  }
  rateEl.addEventListener("input", (e) => setRate(e.target.value));

  $("card").addEventListener("click", () => {
    speakCurrent();
  });

  $("load").addEventListener("click", () => {
    const text = $("input").value.trim();
    const parsed = parseLines(text);
    if (parsed.length === 0) {
      alert("í˜•ì‹ì´ ì•ˆ ë§ì•„! ìµœì†Œ (í•œì,ë³‘ìŒ,í•œêµ­ì–´) ë˜ëŠ” (í•œì ë³‘ìŒ í•œêµ­ì–´ í’ˆì‚¬) í˜•íƒœì—¬ì•¼ í•´.");
      return;
    }
    cards = parsed;
    idx = 0;
    render();
    save();
  });

  $("sample").addEventListener("click", () => {
    $("input").value =
`åœ°é“,dÃ¬tiÄ›,ì§€í•˜ì² /ì „ì² ,ëª…ì‚¬
æŒ¤,jÇ,ë¶ë¹„ë‹¤,í˜•ìš©ì‚¬/ë™ì‚¬
å¤ªæŒ¤äº†,tÃ i jÇ le,ë„ˆë¬´ ë¶ë¹ˆë‹¤,êµ¬ì–´í‘œí˜„

æ—©ä¸Š zÇoshang ì•„ì¹¨ ëª…ì‚¬
å zuÃ² íƒ€ë‹¤(êµí†µìˆ˜ë‹¨) ë™ì‚¬`;
    localStorage.setItem(INPUT_KEY, $("input").value);
  });

  $("clear").addEventListener("click", () => {
    if (!confirm("ì €ì¥ëœ ë°ì´í„°/ì…ë ¥ì¹¸/ì„¤ì •ë„ ê°™ì´ ì§€ìš¸ê¹Œ?")) return;
    cards = []; idx = 0; hideMeaning = false;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(INPUT_KEY);
    localStorage.removeItem(TTS_KEY);
    $("input").value = "";
    $("toggleHide").textContent = "ëœ» ê°€ë¦¬ê¸°";
    setRate(0.9);
    chosenVoiceName = "auto";
    render();
    refreshVoiceLabel();
    // ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ìë™ ë¡œë“œ ì‹œë„
    autoLoadDefaultIfNeeded();
  });

  $("input").addEventListener("input", () => {
    localStorage.setItem(INPUT_KEY, $("input").value);
  });

  window.addEventListener("keydown", (e) => {
    if (e.target && (e.target.tagName === "TEXTAREA" || e.target.tagName === "INPUT")) return;
    if (e.key === "ArrowRight") next();
    if (e.key === "ArrowLeft") prev();
    if (e.key.toLowerCase() === "r") randomPick();
    if (e.key.toLowerCase() === "h") $("toggleHide").click();
    if (e.key.toLowerCase() === "s") speakCurrent();
  });

  if ("speechSynthesis" in window) {
    window.speechSynthesis.onvoiceschanged = () => {
      refreshVoiceLabel();
    };
  }

  // init
  loadSaved();
  $("toggleHide").textContent = hideMeaning ? "ëœ» ë³´ì´ê¸°" : "ëœ» ê°€ë¦¬ê¸°";
  setRate(ttsRate);
  render();

  setTimeout(refreshVoiceLabel, 250);
  setTimeout(refreshVoiceLabel, 1000);

  // âœ… ì—¬ê¸°ì„œ ìë™ ë¡œë“œ ì‹¤í–‰
  autoLoadDefaultIfNeeded();
</script>
</body>
</html>
